# ngDocCode - BreezeJS exploratory tests in Angular

Demonstrates through automated tests how BreezeJS works within an Angular application 

## Structure
	/build 	(created on the fly)
	/gulp	
	/public
		/test
			/lib
    server.js
	

## Installing Node.js and Bower Packages

- Open terminal or command window
- Enter `npm install`

>For a pristine re-install, first delete both *node_modules* and *bower_components*.

## Installing Bower Packages
`npm install` will install these too, but you can do it manually.

- Open terminal or command window
- Enter `bower install`

>While the bower package is the official stable release, you can
get the most recently committed Breeze.js file versions by running the *getLibs.cmd* command (Windows only).

## Running the tests

You can run the tests in several ways:

1. Open *index.html* in a browser directly from the file system
2. With gulp
3. With Web Storm

Details of these approaches follow.

**Regardless of approach you must start the remote server first**.
Many of the tests are "midway integration tests" that make calls to a remote server.  See the **["*Starting the Server*" section](#startServer)** below.

<a name="indexhtmlTest"></a>
### Testing with *index.html*

The tests can be run directly in the browser if your OS and browser permit running HTML files from the local file system.

1. Start the remote server (see **["*Starting the Server*"](#startServer)**).

1. Double-click the *index.html* located in the root of the ngDocCode directory. A browser should open and the tests should run.

    Alternatively, locate *index.html* and paste it into the browser address bar.

>This *index.html* page is generated by the gulp task: `gulp build-index`

<a name="gulpTest"></a>
### Testing with gulp

Open a command/terminal window and enter `gulp test`.

This gulp task runs all tests *once*, including the midway tests, and then shuts down.

Entering `gulp autotest` runs all tests and stays alive. It creates a watch on the pertinent files, with a 5 second delay, and re-runs the tests automatically when any of them change.

You can start the server first by adding the "`--startServer`" flag
to the command as in:

	gulp autotest --startServer
	gulp test --startServer

>The gulp test task doesn't shut the server down yet.

<a name="webstormTest"></a>
### Testing with Web Storm

Web Storm is a nice IDE for development and debugging. You can run the tests inside Web Storm with Karma or as a Node application.

####Run with Karma

1. Create a Web Storm configuration for "karma" (one time setup)

	* [ctrl-shift-A], "Edit Configurations"
	
    * click the "+" icon to create a new configuration

    * Select the "Karma" default template
    
    * Name it (e.g, "Karma")
    
	* For "Configuation file" navigate to `karma.conf.js` at root level
	
    * Click [OK].

1. Start the remote server (see **["*Starting the Server*"](#startServer)**).

1. Select the "Karma" Web Storm configuration

1. [ctrl-F5] to launch or click the "Play" icon in the upper right toolbar.

#### Run as node application

You can also run the tests in a browser with a node/express server.

1. Create a Web Storm configuration for "App" (one time setup)

	* [ctrl-shift-A], "Edit Configurations"
	
    * click the "+" icon to create a new configuration

    * Select the "Node.js" default template
    
    * Name it (e.g, "App")
    
	* For "JavaScript file" enter `server.js`
	
    * Click [OK].

1. Start the remote server (see **["*Starting the Server*"](#startServer)**).

1. Select the "App" Web Storm configuration

1. [ctrl-F5] to launch or click the "Play" icon in the upper right toolbar.
>Review the Web Storm documentation for further details.

## Debugging Tests

You can debug the tests in Web Storm but most of us will debug them in a browser. How you do that depends upon how you're running the tests.

### Running in a browser

* Open the browser's Developer Tools (F12).
* Find the source code file(s) of interest and set breakpoints.
* Refresh the browser and have fun.

### Running with Karma

Once the karma server is running.

* Open a browser and navigate to `http://localhost:9876/debug.html`.
* Open the browser's Developer Tools (F12).
* Find the source code file(s) of interest and set breakpoints.
* Refresh the browser and have fun.

## How It Works

The tests (called "specs") are all in the `public/test` folder.

We use **karma** to manage the tests.

Specs are written with **mocha** (the testrunner), **chai** (using *expect* assertions), **sinon** (for mocking), and the **ngMidwayTester** (for angular tests that make AJAX calls to the server).

Specs at the top level can pass without access to a running remote data server. Most of these tests are synchronous. 

Specs in the `server_specs` sub-folder are async "midway" tests that require  a running remote data server. See the **["*Starting the Server*" section](#startServer)**.

Files in the `lib` sub-folder define helpers and test data to facilitate testing.

The helpers pile all of their material into the global namespace called `window.appSpecHelper`; **`window.ash`** is an alias for that namespace and most specs use this alias.


## Disable ng-inspector!
**The ng-inspector chrome plug-in interferes with debugging of tests in chrome.**

You know you've hit the problem when the test fails in a "before hook" and the stack trace mentions "ng-inspector".

Please disable it or remove it from your Chrome extensions.

<a name="startServer"></a>
## Starting the Server

The midway tests talk to a local test server which must already be running.
 
The DocCode Web API server is the current default server and the only server available at this time.


This Web API server is defined in the "net/DocCode" which parallels this "node/ngDocCode" sample.

>Soon we will default to a different node server and you won't need .NET or IISExpress to run these tests.
Until then we still need .NET and this companion
project. Make sure you build it first so the binaries are in place.


The *start-webapi.ps1* PowerShell script cranks up an IISExpress for the Web API server located at 
*../net/DocCode/DocCode*.  

You can run this script from a command window: `powershell -noexit .\start-webapi`
    
>You might create a shortcut for this purpose.
>
>There is also a gulp task to do it: `gulp serve-webapi`

You should see the PowerShell window open and stay open. It says:

    Successfully registered URL "http://localhost:58066/" for site "Development Web Site" application"/"
    Registration completed

The server is running on `http://localhost:58066`

Confirm that it works by opening a browser and navigating to [`http://localhost:58066/breeze/Northwind/employees`](http://localhost:58066/breeze/Northwind/employees). 
After a pause to start the server, it should display the JSON result of an "all employees" query. The PowerShell window should display each request to that server.

Close the PowerShell window to shut down the server when you're done.



